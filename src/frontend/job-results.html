<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery Results - AzFilesOptimizer</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .tree-view {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .tree-node {
            margin-left: 20px;
            margin-bottom: 8px;
        }
        
        .tree-node-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: var(--surface);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .tree-node-header:hover {
            background: #f0f0f0;
        }
        
        .tree-node-icon {
            margin-right: 8px;
            font-size: 14px;
            transition: transform 0.2s;
            display: inline-block;
            width: 16px;
        }
        
        .tree-node-icon.expanded {
            transform: rotate(90deg);
        }
        
        .tree-node-label {
            flex: 1;
            font-weight: 500;
        }
        
        .tree-node-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-left: 8px;
        }
        
        .tree-node-children {
            display: none;
            margin-top: 8px;
        }
        
        .tree-node-children.expanded {
            display: block;
        }
        
        .share-item {
            padding: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .share-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .share-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .share-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .share-detail-item {
            display: inline-block;
            margin-right: 16px;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
        }
        
        .breadcrumb-item::after {
            content: '‚Üí';
            margin: 0 8px;
        }
        
        .breadcrumb-item:last-child::after {
            content: '';
        }
        
        .search-filter {
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-close {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .modal-close:hover {
            color: var(--text);
        }
        
        .metadata-section {
            margin-bottom: 1.5rem;
        }
        
        .metadata-section h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .metadata-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .metadata-value {
            color: var(--text);
            word-break: break-all;
        }
        
        /* View toggle styles */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .view-toggle-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .view-toggle-btn:hover:not(.active) {
            background: var(--surface);
        }
        
        /* Table view styles */
        .table-view {
            display: none;
        }
        
        .table-view.active {
            display: block;
        }
        
        .tree-view.active {
            display: block;
        }
        
        .tree-view:not(.active) {
            display: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th {
            background: var(--surface);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .data-table th:hover {
            background: #e0e0e0;
        }
        
        .data-table th .sort-indicator {
            margin-left: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .data-table th.sorted-asc .sort-indicator::after {
            content: '‚ñ≤';
            color: var(--primary-color);
        }
        
        .data-table th.sorted-desc .sort-indicator::after {
            content: '‚ñº';
            color: var(--primary-color);
        }
        
        .data-table th:not(.sorted-asc):not(.sorted-desc) .sort-indicator::after {
            content: '‚¨ç';
            opacity: 0.3;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .data-table tr:hover {
            background: var(--surface);
            cursor: pointer;
        }
        
        .column-selector {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: 4px;
        }
        
        .column-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .column-checkbox input[type="checkbox"] {
            cursor: pointer;
        }
        
        .column-checkbox label {
            cursor: pointer;
            user-select: none;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>AzFilesOptimizer</h1>
            <div id="auth-section">
                <div id="signed-out-view" style="display: none;">
                    <button class="btn" onclick="window.location.href='index.html'" style="background-color: white; color: var(--primary-color);">Sign In</button>
                </div>
                <div id="signed-in-view" style="display: none;">
                    <span id="user-name" style="color: white; margin-right: 1rem;"></span>
                    <button class="btn" onclick="window.location.href='index.html'" style="background-color: transparent; border: 1px solid white;">Home</button>
                </div>
            </div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="jobs.html">Jobs</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </nav>
    
    <main>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="page-title">Discovery Results</h2>
                <button class="btn" onclick="window.location.href='job-detail.html?id=' + jobId">‚Üê Back to Job</button>
            </div>
            
            <div class="breadcrumb">
                <div class="breadcrumb-item">Subscription</div>
                <div class="breadcrumb-item">Resource Groups</div>
                <div class="breadcrumb-item">Storage Accounts</div>
                <div class="breadcrumb-item">File Shares</div>
            </div>
            
            <div class="summary-stats" id="summary-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-shares">0</div>
                    <div class="stat-label">Azure Files Shares</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-volumes">0</div>
                    <div class="stat-label">ANF Volumes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-storage-accounts">0</div>
                    <div class="stat-label">Storage Accounts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-capacity">0 TB</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
            </div>
            
            <div class="view-toggle">
                <button class="view-toggle-btn active" id="tree-view-btn" onclick="switchView('tree')">üå≥ Hierarchy View</button>
                <button class="view-toggle-btn" id="table-view-btn" onclick="switchView('table')">üìä Table View</button>
            </div>
            
            <!-- Tree View -->
            <div id="tree-view-container" class="tree-view active">
                <div class="search-filter">
                    <input type="text" id="search-input" class="search-input" placeholder="Search shares, storage accounts, resource groups..." onkeyup="filterTree()">
                </div>
                
                <div id="tree-container">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading"></div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading results...</p>
                    </div>
                </div>
            </div>
            
            <!-- Table View -->
            <div id="table-view-container" class="table-view">
                <div class="column-selector" id="column-selector" style="margin-bottom: 1rem;">
                    <div class="column-selector-header" style="cursor: pointer;" onclick="toggleColumnSelector()">
                        <strong>‚ñ∂ Show/Hide Columns</strong>
                    </div>
                    <div class="column-list" id="column-list" style="display: none; margin-top: 0.75rem;">
                        <div style="margin-bottom: 0.75rem;">
                            <button class="btn" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="resetColumns()">Reset to Default</button>
                        </div>
                    </div>
                </div>
                
                <div class="search-filter">
                    <input type="text" id="table-search-input" class="search-input" placeholder="Search volumes..." onkeyup="filterTable()">
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="data-table">
                        <thead id="table-header"></thead>
                        <tbody id="table-body">
                            <tr>
                                <td colspan="20" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div>
                                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Share Detail Modal -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Share Details</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="js/lib/msal-browser.min.js"></script>
    <script src="js/auth-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/toast.js"></script>
    <script>
        let jobId = '';
        let sharesData = [];
        let volumesData = [];
        let hierarchyData = {};
        
        // Get job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        jobId = urlParams.get('id');
        
        if (!jobId) {
            alert('No job ID provided');
            window.location.href = 'jobs.html';
        }
        
        // Helper function to format numbers with thousands separators
        function formatNumber(num, decimals = null) {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            
            // Auto-determine decimals if not specified
            if (decimals === null) {
                decimals = (num % 1 === 0) ? 0 : 2;
            }
            
            return num.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        // Helper function for formatting usage with better precision
        function formatUsage(usageBytes) {
            if (usageBytes === null || usageBytes === undefined) return 'N/A';
            if (usageBytes === 0) return '0';
            
            const gib = usageBytes / (1024**3);
            
            if (gib < 0.001) {
                // Show in MiB for very small values
                const mib = usageBytes / (1024**2);
                if (mib < 0.001) {
                    // Show in KiB for tiny values
                    const kib = usageBytes / 1024;
                    return kib < 0.001 ? `${usageBytes} B` : `${formatNumber(kib, 2)} KiB`;
                }
                return `${formatNumber(mib, 2)} MiB`;
            } else if (gib < 1) {
                // Show 3 decimal places for values less than 1 GiB
                return formatNumber(gib, 3);
            } else {
                // Show 2 decimal places for values >= 1 GiB
                return formatNumber(gib, 2);
            }
        }

        const SCALE_TARGETS_URL = 'https://learn.microsoft.com/en-us/azure/storage/files/storage-files-scale-targets';
        function formatPerf(actual, estimated, suffix = '') {
            if (actual !== null && actual !== undefined) {
                return `${formatNumber(actual)}${suffix}`;
            }
            if (estimated !== null && estimated !== undefined) {
                return `<span title="Estimated from Azure Files scale targets; actual is not provisioned for this tier.">${formatNumber(estimated)}${suffix} (est) <a href="${SCALE_TARGETS_URL}" target="_blank" rel="noopener">‚Ñπ</a></span>`;
            }
            return 'N/A';
        }
        
        // Helper function to format ANF SKU with service level and cool access
        function formatAnfSku(volume) {
            if (!volume) return 'N/A';
            
            let sku = volume.ServiceLevel || 'Standard';
            
            // Check if it's Flexible tier (has manual throughput)
            if (volume.PoolQosType === 'Manual') {
                sku = 'Flexible-Capacity + Flexible-Throughput';
            }
            
            // Add Cool Access SKUs if enabled
            if (volume.CoolAccessEnabled) {
                sku += ' + Cool + CoolTransfer';
            }
            
            return sku;
        }
        
        // Helper function to render historical metrics summary
        function renderMetricsSummary(metricsSummaryJson) {
            if (!metricsSummaryJson) return '';
            
            try {
                const metrics = JSON.parse(metricsSummaryJson);
                if (!metrics || Object.keys(metrics).length === 0) return '';
                
                const metricLabels = {
                    'Transactions': 'Transactions',
                    'Ingress': 'Ingress',
                    'Egress': 'Egress',
                    'SuccessServerLatency': 'Latency (ms)',
                    'Availability': 'Availability (%)',
                    'VolumeLogicalSize': 'Logical Size',
                    'ReadIops': 'Read IOPS',
                    'WriteIops': 'Write IOPS',
                    'VolumeThroughputReadBytes': 'Read Throughput',
                    'VolumeThroughputWriteBytes': 'Write Throughput',
                    'VolumeConsumedSizePercentage': 'Consumed %'
                };
                
                let html = '<div style="margin-top: 1rem; padding: 1rem; background: #f0f7ff; border-radius: 4px; border-left: 4px solid var(--primary-color);">';
                html += '<strong style="display: block; margin-bottom: 0.75rem;">üìä Historical Metrics (30-day average):</strong>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">';
                
                for (const [metricName, data] of Object.entries(metrics)) {
                    const label = metricLabels[metricName] || metricName;
                    const avgValue = data.average || 0;
                    const maxValue = data.max || 0;
                    
                    // Format values based on metric type
                    let formattedAvg = formatNumber(avgValue);
                    let formattedMax = formatNumber(maxValue);
                    
                    if (metricName.includes('Bytes') || metricName.includes('Size')) {
                        formattedAvg = formatUsage(avgValue);
                        formattedMax = formatUsage(maxValue);
                    } else if (metricName.includes('Availability')) {
                        formattedAvg = avgValue.toFixed(2) + '%';
                        formattedMax = maxValue.toFixed(2) + '%';
                    } else if (metricName.includes('Latency')) {
                        formattedAvg = avgValue.toFixed(2);
                        formattedMax = maxValue.toFixed(2);
                    }
                    
                    html += `
                        <div style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #e0e0e0;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">${label}</div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--primary-color);">${formattedAvg}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">max: ${formattedMax}</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
                return html;
            } catch (error) {
                console.error('Error parsing metrics summary:', error);
                return '';
            }
        }
        
        async function loadResults() {
            try {
                // Load job details
                const job = await apiClient.getJob(jobId);
                document.getElementById('page-title').textContent = `Discovery Results - Job ${jobId.substring(0, 8)}`;
                
                // Load discovered resources
                const results = await apiClient.getJobShares(jobId);
                sharesData = results.shares || [];
                volumesData = results.volumes || [];
                
                // Update summary stats
                updateStats();
                
                // Build hierarchy
                buildHierarchy();
                
                // Render tree
                renderTree();
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('tree-container').innerHTML = `
                    <div class="error-message">
                        <strong>Error loading results:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        function updateStats() {
            document.getElementById('total-shares').textContent = formatNumber(sharesData.length, 0);
            document.getElementById('total-volumes').textContent = formatNumber(volumesData.length, 0);
            
            // Count unique storage accounts
            const storageAccounts = new Set(sharesData.map(s => s.StorageAccountName));
            document.getElementById('total-storage-accounts').textContent = formatNumber(storageAccounts.size, 0);
            
            // Calculate total capacity
            const totalBytes = sharesData.reduce((sum, s) => sum + ((s.ShareQuotaGiB || 0) * 1024 * 1024 * 1024), 0);
            const totalTB = totalBytes / (1024 * 1024 * 1024 * 1024);
            document.getElementById('total-capacity').textContent = `${formatNumber(totalTB)} TB`;
        }
        
        function buildHierarchy() {
            hierarchyData = {};
            
            sharesData.forEach(share => {
                const sub = share.SubscriptionId || 'Unknown';
                const rg = share.ResourceGroup || 'Unknown';
                const sa = share.StorageAccountName || 'Unknown';
                
                if (!hierarchyData[sub]) {
                    hierarchyData[sub] = { resourceGroups: {}, subscriptionId: sub };
                }
                
                if (!hierarchyData[sub].resourceGroups[rg]) {
                    hierarchyData[sub].resourceGroups[rg] = { storageAccounts: {}, name: rg };
                }
                
                if (!hierarchyData[sub].resourceGroups[rg].storageAccounts[sa]) {
                    hierarchyData[sub].resourceGroups[rg].storageAccounts[sa] = { 
                        shares: [],
                        name: sa,
                        sku: share.StorageAccountSku,
                        location: share.Location
                    };
                }
                
                hierarchyData[sub].resourceGroups[rg].storageAccounts[sa].shares.push(share);
            });
        }
        
        function renderTree() {
            const container = document.getElementById('tree-container');
            container.innerHTML = '';
            
            Object.keys(hierarchyData).forEach(subId => {
                const subData = hierarchyData[subId];
                const subNode = createTreeNode(`üìã Subscription: ${subId.substring(0, 20)}...`, Object.keys(subData.resourceGroups).length, 'subscription');
                
                const rgContainer = document.createElement('div');
                rgContainer.className = 'tree-node-children';
                
                Object.keys(subData.resourceGroups).forEach(rgName => {
                    const rgData = subData.resourceGroups[rgName];
                    const rgNode = createTreeNode(`üìÅ ${rgName}`, Object.keys(rgData.storageAccounts).length, 'resource-group');
                    
                    const saContainer = document.createElement('div');
                    saContainer.className = 'tree-node-children';
                    
                    Object.keys(rgData.storageAccounts).forEach(saName => {
                        const saData = rgData.storageAccounts[saName];
                        const saNode = createTreeNode(
                            `üíæ ${saName} (${saData.sku || 'Unknown'})`, 
                            saData.shares.length,
                            'storage-account'
                        );
                        
                        const sharesContainer = document.createElement('div');
                        sharesContainer.className = 'tree-node-children';
                        
                        saData.shares.forEach(share => {
                            const shareItem = createShareItem(share);
                            sharesContainer.appendChild(shareItem);
                        });
                        
                        // Storage Account wrapper
                        const saWrapper = document.createElement('div');
                        saWrapper.className = 'tree-node';
                        saWrapper.appendChild(saNode);
                        saWrapper.appendChild(sharesContainer);
                        
                        saContainer.appendChild(saWrapper);
                    });
                    
                    // Resource Group wrapper
                    const rgWrapper = document.createElement('div');
                    rgWrapper.className = 'tree-node';
                    rgWrapper.appendChild(rgNode);
                    rgWrapper.appendChild(saContainer);
                    
                    rgContainer.appendChild(rgWrapper);
                });
                
                // Subscription wrapper
                const subWrapper = document.createElement('div');
                subWrapper.className = 'tree-node';
                subWrapper.appendChild(subNode);
                subWrapper.appendChild(rgContainer);
                
                container.appendChild(subWrapper);
            });
        }
        
        function createTreeNode(label, count, type) {
            const header = document.createElement('div');
            header.className = 'tree-node-header';
            header.onclick = function() { toggleNode(this); };
            
            header.innerHTML = `
                <span class="tree-node-icon">‚ñ∂</span>
                <span class="tree-node-label">${label}</span>
                <span class="tree-node-count">(${count})</span>
            `;
            
            return header;
        }
        
        function createShareItem(share) {
            const item = document.createElement('div');
            item.className = 'share-item';
            item.onclick = function() { showShareDetails(share); };
            
            const quotaGB = share.ShareQuotaGiB || 0;
            const usageDisplay = formatUsage(share.ShareUsageBytes);
            const tier = share.AccessTier || 'Unknown';
            const protocols = share.EnabledProtocols ? share.EnabledProtocols.join(', ') : 'SMB';
            
            item.innerHTML = `
                <div class="share-name">üìÑ ${share.ShareName}</div>
                <div class="share-details">
                    <span class="share-detail-item"><strong>Tier:</strong> ${tier}</span>
                    <span class="share-detail-item"><strong>Quota:</strong> ${quotaGB} GiB</span>
                    <span class="share-detail-item"><strong>Usage:</strong> ${usageDisplay}</span>
                    <span class="share-detail-item"><strong>Protocol:</strong> ${protocols}</span>
                </div>
            `;
            
            return item;
        }
        
        function toggleNode(header) {
            const icon = header.querySelector('.tree-node-icon');
            const parent = header.parentElement;
            const children = parent.querySelector('.tree-node-children');
            
            if (children) {
                children.classList.toggle('expanded');
                icon.classList.toggle('expanded');
            }
        }
        
        function showShareDetails(share) {
            document.getElementById('modal-title').textContent = `${share.ShareName} - Details`;
            
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="metadata-section">
                    <h3>Basic Information</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Share Name:</div>
                        <div class="metadata-value">${share.ShareName}</div>
                        <div class="metadata-label">Storage Account:</div>
                        <div class="metadata-value">${share.StorageAccountName}</div>
                        <div class="metadata-label">Resource Group:</div>
                        <div class="metadata-value">${share.ResourceGroup}</div>
                        <div class="metadata-label">Location:</div>
                        <div class="metadata-value">${share.Location}</div>
                        <div class="metadata-label">Access Tier:</div>
                        <div class="metadata-value">${share.AccessTier || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h3>Storage Account Properties</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">SKU:</div>
                        <div class="metadata-value">${share.StorageAccountSku || 'N/A'}</div>
                        <div class="metadata-label">Kind:</div>
                        <div class="metadata-value">${share.StorageAccountKind || 'N/A'}</div>
                        <div class="metadata-label">HTTPS Only:</div>
                        <div class="metadata-value">${share.EnableHttpsTrafficOnly ? 'Yes' : 'No'}</div>
                        <div class="metadata-label">Minimum TLS:</div>
                        <div class="metadata-value">${share.MinimumTlsVersion || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h3>Capacity & Performance</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Quota:</div>
                        <div class="metadata-value">${share.ShareQuotaGiB || 0} GiB</div>
                        <div class="metadata-label">Usage:</div>
                        <div class="metadata-value">${formatUsage(share.ShareUsageBytes)}</div>
                        <div class="metadata-label">Provisioned IOPS:</div>
                        <div class="metadata-value">${formatPerf(share.ProvisionedIops, share.EstimatedIops)}</div>
                        <div class="metadata-label">Provisioned Bandwidth:</div>
                        <div class="metadata-value">${formatPerf(share.ProvisionedBandwidthMiBps, share.EstimatedThroughputMiBps, ' MiB/s')}</div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h3>Network & Access</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Enabled Protocols:</div>
                        <div class="metadata-value">${share.EnabledProtocols ? share.EnabledProtocols.join(', ') : 'SMB'}</div>
                        <div class="metadata-label">Root Squash:</div>
                        <div class="metadata-value">${share.RootSquash || 'N/A'}</div>
                        <div class="metadata-label">Lease Status:</div>
                        <div class="metadata-value">${share.LeaseStatus || 'N/A'}</div>
                        <div class="metadata-label">Lease State:</div>
                        <div class="metadata-value">${share.LeaseState || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h3>Snapshots & Backup</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Snapshot Count:</div>
                        <div class="metadata-value">${share.SnapshotCount != null ? formatNumber(share.SnapshotCount, 0) : 'N/A'}</div>
                        <div class="metadata-label">Total Snapshot Size:</div>
                        <div class="metadata-value">${share.TotalSnapshotSizeBytes ? formatUsage(share.TotalSnapshotSizeBytes) : 'N/A'}</div>
                        <div class="metadata-label">Churn Rate (per day):</div>
                        <div class="metadata-value">${share.ChurnRateBytesPerDay ? formatUsage(share.ChurnRateBytesPerDay) : 'N/A'}</div>
                        <div class="metadata-label">Backup Policy:</div>
                        <div class="metadata-value">${share.BackupPolicyConfigured ? 'Configured' : 'N/A'}</div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h3>Monitoring</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Monitoring Enabled:</div>
                        <div class="metadata-value">${share.MonitoringEnabled ? 'Yes' : 'No'}</div>
                        <div class="metadata-label">Historical Data Available:</div>
                        <div class="metadata-value">${share.MonitoringDataAvailableDays ? `${share.MonitoringDataAvailableDays} days` : 'N/A'}</div>
                    </div>
                    ${share.HistoricalMetricsSummary ? renderMetricsSummary(share.HistoricalMetricsSummary) : ''}
                </div>
                
                <div class="metadata-section">
                    <h3>Timestamps</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Last Modified:</div>
                        <div class="metadata-value">${share.LastModifiedTime ? new Date(share.LastModifiedTime).toLocaleString() : 'N/A'}</div>
                        <div class="metadata-label">Discovered At:</div>
                        <div class="metadata-value">${share.DiscoveredAt ? new Date(share.DiscoveredAt).toLocaleString() : 'N/A'}</div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h3>Advanced</h3>
                    <div class="metadata-grid">
                        <div class="metadata-label">Resource ID:</div>
                        <div class="metadata-value" style="font-size: 0.75rem;">${share.ResourceId}</div>
                        <div class="metadata-label">Snapshot:</div>
                        <div class="metadata-value">${share.IsSnapshot ? 'Yes' : 'No'}</div>
                        <div class="metadata-label">Deleted:</div>
                        <div class="metadata-value">${share.IsDeleted ? 'Yes' : 'No'}</div>
                    </div>
                </div>
                
                ${share.Tags && Object.keys(share.Tags).length > 0 ? `
                <div class="metadata-section">
                    <h3>Tags</h3>
                    <div class="metadata-grid">
                        ${Object.entries(share.Tags).map(([key, value]) => `
                            <div class="metadata-label">${key}:</div>
                            <div class="metadata-value">${value}</div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('share-modal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('share-modal').style.display = 'none';
        }
        
        function filterTree() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                // Show all
                document.querySelectorAll('.tree-node, .share-item').forEach(el => {
                    el.style.display = '';
                });
                return;
            }
            
            // Filter logic
            document.querySelectorAll('.share-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            // Auto-expand nodes that have visible shares
            document.querySelectorAll('.tree-node').forEach(node => {
                const hasVisibleShares = Array.from(node.querySelectorAll('.share-item'))
                    .some(item => item.style.display !== 'none');
                
                if (hasVisibleShares) {
                    const children = node.querySelector('.tree-node-children');
                    const icon = node.querySelector('.tree-node-icon');
                    if (children && icon) {
                        children.classList.add('expanded');
                        icon.classList.add('expanded');
                    }
                }
            });
        }
        
        function updateAuthUI() {
            const signedInView = document.getElementById('signed-in-view');
            const signedOutView = document.getElementById('signed-out-view');
            const userNameElement = document.getElementById('user-name');

            if (authManager.isSignedIn()) {
                signedInView.style.display = 'block';
                signedOutView.style.display = 'none';
                userNameElement.textContent = authManager.getUserDisplayName();
            } else {
                signedInView.style.display = 'none';
                signedOutView.style.display = 'block';
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('share-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // ==============
        // TABLE VIEW
        // ==============
        
        const DEFAULT_COLUMNS = ['VolumeName', 'Service', 'PerformanceTier', 'CapacityGiB', 'UsedGiB'];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        const COLUMN_DEFINITIONS = [
            { key: 'VolumeName', label: 'Volume Name', format: (v) => v.ShareName || v.VolumeName },
            { key: 'Service', label: 'Service', format: (v) => v.ShareName ? 'Azure Files' : 'ANF' },
            { key: 'StorageAccountName', label: 'Storage Account / NetApp Account', format: (v) => v.StorageAccountName || v.NetAppAccountName },
            { key: 'ResourceGroup', label: 'Resource Group', format: (v) => v.ResourceGroup },
            { key: 'SubscriptionId', label: 'Subscription ID', format: (v) => v.SubscriptionId },
            { key: 'Location', label: 'Location', format: (v) => v.Location },
            { key: 'PerformanceTier', label: 'Performance Tier', format: (v) => v.AccessTier || v.ServiceLevel },
            { key: 'CapacityGiB', label: 'Capacity (GiB)', format: (v) => v.ShareQuotaGiB ? formatNumber(v.ShareQuotaGiB) : (v.ProvisionedSizeBytes ? formatNumber(v.ProvisionedSizeBytes / (1024**3)) : 'N/A') },
            { key: 'UsedGiB', label: 'Used (GiB)', format: (v) => formatUsage(v.ShareUsageBytes) },
            { key: 'StorageAccountSku', label: 'SKU', format: (v) => v.ShareName ? (v.StorageAccountSku || 'N/A') : formatAnfSku(v) },
            { key: 'StorageAccountKind', label: 'Storage Account Kind', format: (v) => v.ShareName ? (v.StorageAccountKind || 'N/A') : 'ANF' },
            { key: 'EnabledProtocols', label: 'Protocols', format: (v) => (v.EnabledProtocols || v.ProtocolTypes)?.join(', ') || 'SMB' },
            { key: 'MinimumTlsVersion', label: 'Min TLS Version', format: (v) => v.MinimumTlsVersion || 'N/A' },
            { key: 'EnableHttpsTrafficOnly', label: 'HTTPS Only', format: (v) => v.EnableHttpsTrafficOnly ? 'Yes' : 'No' },
            { key: 'ProvisionedIops', label: 'Provisioned/Estimated IOPS', format: (v) => formatPerf(v.ProvisionedIops, v.EstimatedIops) },
            { key: 'ProvisionedBandwidthMiBps', label: 'Provisioned/Estimated Bandwidth (MiB/s)', format: (v) => formatPerf(v.ProvisionedBandwidthMiBps ?? v.ActualThroughputMibps, v.EstimatedThroughputMiBps, ' MiB/s') },
            { key: 'LeaseStatus', label: 'Lease Status', format: (v) => v.LeaseStatus || 'N/A' },
            { key: 'LeaseState', label: 'Lease State', format: (v) => v.LeaseState || 'N/A' },
            { key: 'IsSnapshot', label: 'Is Snapshot', format: (v) => v.IsSnapshot ? 'Yes' : 'No' },
            { key: 'IsDeleted', label: 'Is Deleted', format: (v) => v.IsDeleted ? 'Yes' : 'No' },
            { key: 'LastModifiedTime', label: 'Last Modified', format: (v) => v.LastModifiedTime ? new Date(v.LastModifiedTime).toLocaleDateString() : 'N/A' },
            { key: 'DiscoveredAt', label: 'Discovered At', format: (v) => new Date(v.DiscoveredAt).toLocaleDateString() },
            { key: 'CapacityPoolName', label: 'Capacity Pool (ANF)', format: (v) => v.CapacityPoolName || 'N/A' },
            { key: 'RootSquash', label: 'Root Squash', format: (v) => v.RootSquash || 'N/A' },
            { key: 'SnapshotCount', label: 'Snapshots', format: (v) => v.SnapshotCount != null ? formatNumber(v.SnapshotCount, 0) : 'N/A' },
            { key: 'TotalSnapshotSizeBytes', label: 'Snapshot Size', format: (v) => v.TotalSnapshotSizeBytes ? formatUsage(v.TotalSnapshotSizeBytes) : 'N/A' },
            { key: 'ChurnRateBytesPerDay', label: 'Churn Rate/Day', format: (v) => v.ChurnRateBytesPerDay ? formatUsage(v.ChurnRateBytesPerDay) : 'N/A' },
            { key: 'MonitoringEnabled', label: 'Monitoring', format: (v) => v.MonitoringEnabled ? `‚úì ${v.MonitoringDataAvailableDays || '?'} days` : 'No' }
        ];
        
        function getVisibleColumns() {
            const stored = localStorage.getItem('azfo-visible-columns');
            return stored ? JSON.parse(stored) : DEFAULT_COLUMNS;
        }
        
        function saveVisibleColumns(columns) {
            localStorage.setItem('azfo-visible-columns', JSON.stringify(columns));
        }
        
        function switchView(viewType) {
            const treeViewBtn = document.getElementById('tree-view-btn');
            const tableViewBtn = document.getElementById('table-view-btn');
            const treeViewContainer = document.getElementById('tree-view-container');
            const tableViewContainer = document.getElementById('table-view-container');
            
            if (viewType === 'tree') {
                treeViewBtn.classList.add('active');
                tableViewBtn.classList.remove('active');
                treeViewContainer.classList.add('active');
                tableViewContainer.classList.remove('active');
            } else {
                tableViewBtn.classList.add('active');
                treeViewBtn.classList.remove('active');
                tableViewContainer.classList.add('active');
                treeViewContainer.classList.remove('active');
                
                // Initialize table view if not done yet
                if (!tableViewContainer.dataset.initialized) {
                    initializeTableView();
                    tableViewContainer.dataset.initialized = 'true';
                }
            }
        }
        
        function initializeTableView() {
            renderColumnSelector();
            renderTable();
        }
        
        function toggleColumnSelector() {
            const columnList = document.getElementById('column-list');
            const header = document.querySelector('.column-selector-header strong');
            const isVisible = columnList.style.display !== 'none';
            
            columnList.style.display = isVisible ? 'none' : 'block';
            header.textContent = isVisible ? '‚ñ∂ Show/Hide Columns' : '‚ñº Show/Hide Columns';
            
            // Save preference
            localStorage.setItem('azfo-column-selector-open', !isVisible);
        }
        
        function renderColumnSelector() {
            const columnList = document.getElementById('column-list');
            const visibleColumns = getVisibleColumns();
            
            // Check saved preference
            const savedOpen = localStorage.getItem('azfo-column-selector-open') === 'true';
            if (savedOpen) {
                columnList.style.display = 'block';
                document.querySelector('.column-selector-header strong').textContent = '‚ñº Show/Hide Columns';
            }
            
            const checkboxesHtml = COLUMN_DEFINITIONS.map(col => `
                <div class="column-checkbox">
                    <input type="checkbox" id="col-${col.key}" value="${col.key}" 
                           ${visibleColumns.includes(col.key) ? 'checked' : ''}
                           onchange="toggleColumn('${col.key}')">
                    <label for="col-${col.key}">${col.label}</label>
                </div>
            `).join('');
            
            // Insert checkboxes after the button div
            const buttonDiv = columnList.querySelector('div');
            columnList.innerHTML = buttonDiv.outerHTML + checkboxesHtml;
        }
        
        function toggleColumn(columnKey) {
            let visibleColumns = getVisibleColumns();
            
            if (visibleColumns.includes(columnKey)) {
                visibleColumns = visibleColumns.filter(c => c !== columnKey);
            } else {
                visibleColumns.push(columnKey);
            }
            
            saveVisibleColumns(visibleColumns);
            renderTable();
        }
        
        function resetColumns() {
            saveVisibleColumns(DEFAULT_COLUMNS);
            renderColumnSelector();
            renderTable();
        }
        
        function sortTable(columnKey) {
            if (currentSortColumn === columnKey) {
                // Toggle direction
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to ascending
                currentSortColumn = columnKey;
                currentSortDirection = 'asc';
            }
            
            renderTable();
        }
        
        function renderTable() {
            const visibleColumns = getVisibleColumns();
            const visibleColumnDefs = COLUMN_DEFINITIONS.filter(col => visibleColumns.includes(col.key));
            
            // Combine shares and volumes
            let allVolumes = [...sharesData, ...volumesData];
            
            // Sort if column is selected
            if (currentSortColumn) {
                const sortCol = COLUMN_DEFINITIONS.find(c => c.key === currentSortColumn);
                if (sortCol) {
                    allVolumes.sort((a, b) => {
                        const aVal = sortCol.format(a);
                        const bVal = sortCol.format(b);
                        
                        // Handle 'N/A' values
                        if (aVal === 'N/A') return 1;
                        if (bVal === 'N/A') return -1;
                        
                        // Try numeric comparison first
                        const aNum = parseFloat(aVal);
                        const bNum = parseFloat(bVal);
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            return currentSortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                        }
                        
                        // String comparison
                        const aStr = String(aVal).toLowerCase();
                        const bStr = String(bVal).toLowerCase();
                        
                        if (currentSortDirection === 'asc') {
                            return aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
                        } else {
                            return bStr < aStr ? -1 : bStr > aStr ? 1 : 0;
                        }
                    });
                }
            }
            
            // Render header
            const header = document.getElementById('table-header');
            header.innerHTML = `
                <tr>
                    ${visibleColumnDefs.map(col => {
                        const sortClass = currentSortColumn === col.key ? 
                            (currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                        return `<th class="${sortClass}" onclick="sortTable('${col.key}')">
                            ${col.label}
                            <span class="sort-indicator"></span>
                        </th>`;
                    }).join('')}
                </tr>
            `;
            
            // Render body
            const tbody = document.getElementById('table-body');
            if (allVolumes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + visibleColumnDefs.length + '" style="text-align: center; padding: 2rem;">No data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = allVolumes.map(volume => {
                const cells = visibleColumnDefs.map(col => {
                    const value = col.format(volume);
                    return `<td>${value}</td>`;
                }).join('');
                
                const volumeJson = JSON.stringify(volume).replace(/"/g, '&quot;');
                return `<tr onclick='showShareDetails(${volumeJson})'>${cells}</tr>`;
            }).join('');
        }
        
        function filterTable() {
            const searchTerm = document.getElementById('table-search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Initialize
        async function initialize() {
            try {
                await authManager.initialize();
                
                // Require authentication for this page
                const isAuthenticated = await authManager.requireAuth();
                if (!isAuthenticated) return;
                
                updateAuthUI();
                loadResults();
            } catch (error) {
                console.error('Initialization failed:', error);
                Toast.error('Failed to initialize. Please refresh the page.');
            }
        }
        
        initialize();
    </script>
</body>
</html>
