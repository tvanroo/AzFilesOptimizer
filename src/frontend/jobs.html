<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AzFilesOptimizer - Jobs</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>AzFilesOptimizer</h1>
            <div id="auth-section">
                <div id="signed-out-view" style="display: none;">
                    <button class="btn" onclick="window.location.href='index.html'" style="background-color: white; color: var(--primary-color);">Sign In</button>
                </div>
                <div id="signed-in-view" style="display: none;">
                    <span id="user-name" style="color: white; margin-right: 1rem;"></span>
                    <button class="btn" onclick="window.location.href='index.html'" style="background-color: transparent; border: 1px solid white;">Home</button>
                </div>
            </div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="jobs.html" class="active">Jobs</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </nav>
    
    <main>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin-bottom: 0;">Jobs</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" id="delete-selected-btn" onclick="deleteSelectedJobs()" style="display: none; background-color: #f44336; color: white;">ðŸ—‘ Delete Selected</button>
                    <button class="btn" onclick="showCreateJobModal()">+ New Job</button>
                </div>
            </div>
            
            <div id="jobs-container">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                                <th>Job ID</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    <div class="loading"></div>
                                    <p style="margin-top: 1rem; color: var(--text-secondary);">Loading jobs...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="empty-state" style="display: none;">
                <div class="empty-state">
                    <h3>No jobs yet</h3>
                    <p>Create your first discovery or optimization job to get started.</p>
                    <button class="btn" onclick="showCreateJobModal()" style="margin-top: 1rem;">+ Create Job</button>
                </div>
            </div>
            
            <div id="error-container" style="display: none; margin-top: 1rem;"></div>
        </div>
        
        <div class="card">
            <h2>About Jobs</h2>
            <h3 style="font-size: 1rem; margin-top: 1rem;">Discovery Jobs</h3>
            <p>
                Discovery jobs enumerate Azure Files shares and Azure NetApp Files resources 
                within your defined scope (tenant/subscription/resource group filters).
            </p>
            
            <h3 style="font-size: 1rem; margin-top: 1rem;">Optimization Jobs</h3>
            <p>
                Optimization jobs analyze discovered resources and generate AI-powered 
                recommendations for Azure NetApp Files migration candidacy and architecture.
            </p>
        </div>
    </main>
    
    <!-- Create Job Modal -->
    <div id="create-job-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
            <h2>Create Discovery Job</h2>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem; margin-bottom: 1.5rem;">Scan your Azure subscription for Azure Files shares and Azure NetApp Files volumes.</p>
            <form id="create-job-form">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subscription *</label>
                    <select id="subscription-id" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                        <option value="">Loading subscriptions...</option>
                    </select>
                    <small id="subscription-help" style="color: var(--text-secondary); font-size: 0.75rem; display: none;">No subscriptions found. Make sure you're signed in.</small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 500;">Resource Groups (optional)</span>
                        <button type="button" id="refresh-rg-btn" onclick="refreshResourceGroups()" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.875rem; padding: 0;" title="Refresh resource groups list">ðŸ”„ Refresh</button>
                    </label>
                    <select id="resource-groups" multiple size="15" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                        <option value="" disabled>Select a subscription first...</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 0.25rem;">Hold Ctrl/Cmd to select multiple. Leave empty to scan all.</small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn">Create Job</button>
                    <button type="button" class="btn" onclick="hideCreateJobModal()" style="background-color: var(--surface); color: var(--text);">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/lib/msal-browser.min.js"></script>
    <script src="js/auth-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/toast.js"></script>
    <script>
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        
        function getStatusBadge(status) {
            // Handle both enum values (0,1,2,3,4) and string values
            const statusMap = {
                0: 'Pending',
                1: 'Running',
                2: 'Completed',
                3: 'Failed',
                4: 'Cancelled'
            };
            
            let statusText = status;
            if (typeof status === 'number') {
                statusText = statusMap[status] || 'Unknown';
            } else if (!status) {
                statusText = 'Unknown';
            }
            
            const statusLower = statusText.toLowerCase();
            return `<span class="badge ${statusLower}">${statusText}</span>`;
        }
        
        async function loadJobs() {
            const tableBody = document.getElementById('jobs-table-body');
            const emptyState = document.getElementById('empty-state');
            const errorContainer = document.getElementById('error-container');
            
            try {
                // Call real API
                const jobs = await apiClient.getJobs();
                
                if (!jobs || jobs.length === 0) {
                    tableBody.parentElement.parentElement.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                // Show table and hide empty state
                tableBody.parentElement.parentElement.style.display = 'block';
                emptyState.style.display = 'none';
                
                tableBody.innerHTML = jobs.map(job => {
                    // API returns PascalCase fields
                    const jobId = job.RowKey || job.JobId;
                    const status = job.Status;
                    const createdAt = job.CreatedAt;
                    const updatedAt = job.UpdatedAt;
                    
                    return `
                    <tr>
                        <td><input type="checkbox" class="job-checkbox" value="${jobId}" onchange="updateDeleteButton()"></td>
                        <td><a href="job-detail.html?id=${jobId}" style="color: var(--primary-color); text-decoration: none;">${jobId}</a></td>
                        <td>Discovery</td>
                        <td>${getStatusBadge(status)}</td>
                        <td>${formatDate(createdAt)}</td>
                        <td>${updatedAt ? formatDate(updatedAt) : '-'}</td>
                        <td style="display: flex; gap: 0.5rem;">
                            <a href="job-detail.html?id=${jobId}" class="btn" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem;">View</a>
                            <button class="btn" onclick="deleteJob('${jobId}')" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem; background-color: #f44336; color: white;">ðŸ—‘</button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading jobs:', error);
                tableBody.innerHTML = '';
                tableBody.parentElement.parentElement.style.display = 'none';
                errorContainer.style.display = 'block';
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Error loading jobs:</strong> ${error.message}
                        <p style="margin-top: 0.5rem; font-size: 0.875rem;">Make sure the backend is running and you're signed in.</p>
                    </div>
                `;
            }
        }
        
        async function showCreateJobModal() {
            if (!authManager.isSignedIn()) {
                Toast.warning('Please sign in first to create jobs.');
                return;
            }
            
            // Show modal
            document.getElementById('create-job-modal').style.display = 'block';
            
            // Load subscriptions
            await loadSubscriptions();
        }
        
        // Cache for resource groups by subscription ID
        const resourceGroupsCache = {};
        
        async function loadSubscriptions() {
            const subscriptionSelect = document.getElementById('subscription-id');
            const helpText = document.getElementById('subscription-help');
            
            try {
                subscriptionSelect.disabled = true;
                subscriptionSelect.innerHTML = '<option value="">Loading subscriptions...</option>';
                
                const subscriptions = await apiClient.getSubscriptions();
                
                if (!subscriptions || subscriptions.length === 0) {
                    subscriptionSelect.innerHTML = '<option value="">No subscriptions found</option>';
                    helpText.style.display = 'block';
                    return;
                }
                
                // Populate dropdown
                subscriptionSelect.innerHTML = '<option value="">Select a subscription...</option>' + 
                    subscriptions.map(sub => 
                        `<option value="${sub.id}">${sub.name} (${sub.id})</option>`
                    ).join('');
                    
                subscriptionSelect.disabled = false;
                
                // Add listener to load resource groups when subscription changes
                subscriptionSelect.onchange = () => loadResourceGroups(subscriptionSelect.value);
            } catch (error) {
                console.error('Failed to load subscriptions:', error);
                subscriptionSelect.innerHTML = '<option value="">Failed to load subscriptions</option>';
                helpText.textContent = 'Error loading subscriptions. Please try again.';
                helpText.style.display = 'block';
            }
        }
        
        async function loadResourceGroups(subscriptionId, forceRefresh = false) {
            const rgSelect = document.getElementById('resource-groups');
            const refreshBtn = document.getElementById('refresh-rg-btn');
            
            if (!subscriptionId) {
                rgSelect.innerHTML = '<option value="" disabled>Select a subscription first...</option>';
                rgSelect.disabled = true;
                refreshBtn.disabled = true;
                return;
            }
            
            // Check cache first
            if (!forceRefresh && resourceGroupsCache[subscriptionId]) {
                populateResourceGroups(resourceGroupsCache[subscriptionId]);
                return;
            }
            
            try {
                rgSelect.disabled = true;
                refreshBtn.disabled = true;
                rgSelect.innerHTML = '<option value="" disabled>Loading resource groups...</option>';
                
                const resourceGroups = await apiClient.getResourceGroups(subscriptionId);
                
                // Cache the results
                resourceGroupsCache[subscriptionId] = resourceGroups;
                
                populateResourceGroups(resourceGroups);
            } catch (error) {
                console.error('Failed to load resource groups:', error);
                rgSelect.innerHTML = '<option value="" disabled>Failed to load resource groups</option>';
                Toast.error('Failed to load resource groups: ' + error.message);
            } finally {
                refreshBtn.disabled = false;
            }
        }
        
        function populateResourceGroups(resourceGroups) {
            const rgSelect = document.getElementById('resource-groups');
            
            if (!resourceGroups || resourceGroups.length === 0) {
                rgSelect.innerHTML = '<option value="" disabled>No resource groups found</option>';
                rgSelect.disabled = true;
                return;
            }
            
            // Sort by name
            resourceGroups.sort((a, b) => a.name.localeCompare(b.name));
            
            rgSelect.innerHTML = resourceGroups.map(rg => 
                `<option value="${rg.name}">${rg.name} (${rg.location})</option>`
            ).join('');
            
            rgSelect.disabled = false;
        }
        
        function refreshResourceGroups() {
            const subscriptionId = document.getElementById('subscription-id').value;
            if (subscriptionId) {
                loadResourceGroups(subscriptionId, true);
            }
        }
        
        function hideCreateJobModal() {
            document.getElementById('create-job-modal').style.display = 'none';
            document.getElementById('create-job-form').reset();
        }
        
        document.getElementById('create-job-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const subscriptionId = document.getElementById('subscription-id').value;
            const rgSelect = document.getElementById('resource-groups');
            const selectedResourceGroups = Array.from(rgSelect.selectedOptions).map(opt => opt.value);
            
            if (!subscriptionId) {
                Toast.error('Please select a subscription');
                return;
            }
            
            try {
                const job = await apiClient.createDiscoveryJob({
                    subscriptionId: subscriptionId,
                    resourceGroupNames: selectedResourceGroups.length > 0 ? selectedResourceGroups : null
                });
                
                console.log('Job created:', job);
                const jobId = job.JobId || job.RowKey || job.jobId;
                
                if (!jobId) {
                    console.error('No job ID in response:', job);
                    Toast.error('Job created but ID not found in response');
                    return;
                }
                
                hideCreateJobModal();
                Toast.success('Discovery job created successfully!');
                
                // Redirect to job detail page after brief delay
                setTimeout(() => {
                    window.location.href = `job-detail.html?id=${jobId}`;
                }, 500);
            } catch (error) {
                console.error('Error creating job:', error);
                Toast.error('Failed to create job: ' + error.message);
            }
        });
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.job-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateDeleteButton();
        }
        
        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.job-checkbox:checked');
            const deleteBtn = document.getElementById('delete-selected-btn');
            deleteBtn.style.display = checkboxes.length > 0 ? 'inline-block' : 'none';
            deleteBtn.textContent = `ðŸ—‘ Delete Selected (${checkboxes.length})`;
        }
        
        async function deleteJob(jobId) {
            const confirmed = await Toast.confirm(
                'Are you sure you want to delete this job? This action cannot be undone.',
                'Delete Job',
                'Delete',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            try {
                await apiClient.deleteJob(jobId);
                Toast.success('Job deleted successfully');
                loadJobs();
            } catch (error) {
                Toast.error('Failed to delete job: ' + error.message);
            }
        }
        
        async function deleteSelectedJobs() {
            const checkboxes = document.querySelectorAll('.job-checkbox:checked');
            const jobIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (jobIds.length === 0) return;
            
            const confirmed = await Toast.confirm(
                `Are you sure you want to delete ${jobIds.length} job(s)? This action cannot be undone.`,
                'Delete Jobs',
                'Delete All',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            const deleteBtn = document.getElementById('delete-selected-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';
            
            try {
                // Delete jobs in parallel
                await Promise.all(jobIds.map(jobId => apiClient.deleteJob(jobId)));
                
                Toast.success(`${jobIds.length} job(s) deleted successfully`);
                
                // Uncheck select all
                document.getElementById('select-all').checked = false;
                
                // Reload jobs list
                loadJobs();
            } catch (error) {
                Toast.error('Failed to delete some jobs: ' + error.message);
                deleteBtn.disabled = false;
                updateDeleteButton();
            }
        }
        
        function updateAuthUI() {
            const signedInView = document.getElementById('signed-in-view');
            const signedOutView = document.getElementById('signed-out-view');
            const userNameElement = document.getElementById('user-name');

            if (authManager.isSignedIn()) {
                signedInView.style.display = 'block';
                signedOutView.style.display = 'none';
                userNameElement.textContent = authManager.getUserDisplayName();
            } else {
                signedInView.style.display = 'none';
                signedOutView.style.display = 'block';
            }
        }
        
        // Initialize and load jobs on page load
        async function initialize() {
            try {
                await authManager.initialize();
                
                // Require authentication for this page
                const isAuthenticated = await authManager.requireAuth();
                if (!isAuthenticated) return;
                
                updateAuthUI();
                loadJobs();
            } catch (error) {
                console.error('Initialization failed:', error);
                Toast.error('Failed to initialize. Please refresh the page.');
            }
        }
        
        initialize();
    </script>
</body>
</html>
